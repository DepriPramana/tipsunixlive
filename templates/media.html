{% extends "base.html" %}

{% block title %}Media Library - StreamLive{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h2>ðŸ“‚ Media Library</h2>
        <p class="text-muted">Manage your video assets, sync files, and download from Google Drive.</p>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-outline-primary me-2" onclick="syncFiles()">
            <i class="bi bi-arrow-repeat"></i> Sync Files
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#gdriveModal">
            <i class="bi bi-cloud-download"></i> Import from GDrive
        </button>
    </div>
</div>

<div class="row" id="mediaGrid">
    {% for video in videos %}
    <div class="col-md-3 mb-4 video-card-container">
        <div class="card h-100 shadow-sm video-card">
            <div class="position-relative">
                {% if video.thumbnail_path %}
                <img src="/{{ video.thumbnail_path }}" class="card-img-top video-thumbnail" alt="{{ video.name }}">
                {% else %}
                <div class="card-img-top bg-dark d-flex align-items-center justify-content-center"
                    style="height: 160px;">
                    <i class="bi bi-film text-secondary fs-1"></i>
                </div>
                {% endif %}
                <span class="badge bg-dark position-absolute bottom-0 end-0 m-2">{{ video.duration }}</span>
            </div>
            <div class="card-body">
                <h6 class="card-title text-truncate" title="{{ video.name }}">{{ video.name }}</h6>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <span class="badge bg-info text-dark">{{ video.resolution }}</span>
                    <small class="text-muted">{{ (video.file_size / 1024 / 1024)|round(1) }} MB</small>
                </div>
                <!-- Technical Details -->
                <div class="mt-2 text-muted small">
                    <i class="bi bi-upc-scan"></i> {{ video.bitrate // 1000 }} kbps
                    <span class="mx-1">|</span>
                    <i class="bi bi-filetype-{{ video.format }}"></i> {{ video.codec }}
                </div>
            </div>
            <div class="card-footer bg-transparent border-top-0 d-flex justify-content-between">
                <button class="btn btn-sm btn-outline-danger w-100" onclick="deleteVideo({{ video.id }})">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- GDrive Modal -->
<div class="modal fade" id="gdriveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import from Google Drive</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Google Drive Share Link</label>
                    <input type="text" class="form-control" id="gdriveUrl"
                        placeholder="https://drive.google.com/file/d/...">
                    <div class="form-text">Make sure the link is accessible (Public or 'Anyone with the link').</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="startDownload()">Start Download</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    async function deleteVideo(id) {
        if (!confirm('Are you sure you want to delete this video? This cannot be undone.')) return;

        try {
            await axios.delete(`/media/${id}`);
            location.reload();
        } catch (err) {
            alert('Failed to delete video: ' + (err.response?.data?.detail || err.message));
        }
    }

    async function startDownload() {
        const url = document.getElementById('gdriveUrl').value;
        if (!url) return alert('Please enter a URL');

        try {
            const btn = document.querySelector('#gdriveModal .btn-primary');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'Queuing...';

            await axios.post('/media/gdrive/download', { url });

            alert('Download started in background! The video will appear here once finished (refresh page).');
            bootstrap.Modal.getInstance(document.getElementById('gdriveModal')).hide();
            document.getElementById('gdriveUrl').value = '';

            btn.disabled = false;
            btn.innerText = originalText;
        } catch (err) {
            alert('Failed to start download: ' + (err.response?.data?.detail || err.message));

            // Re-enable button
            const btn = document.querySelector('#gdriveModal .btn-primary');
            btn.disabled = false;
            btn.innerText = 'Start Download';
        }
    }

    async function syncFiles() {
        try {
            const btn = document.querySelector('button[onclick="syncFiles()"]');
            const originalIcon = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Scanning...';

            const res = await axios.post('/media/sync');

            alert(`Sync complete! Added ${res.data.added} new videos.`);
            location.reload();
        } catch (err) {
            alert('Sync failed: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = originalIcon;
        }
    }
</script>

<style>
    .video-thumbnail {
        height: 160px;
        object-fit: cover;
    }

    .video-card:hover {
        transform: translateY(-5px);
        transition: transform 0.2s;
    }
</style>
{% endblock %}