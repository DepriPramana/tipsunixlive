{% extends "base.html" %}

{% block title %}Create YouTube Broadcast - YouTube Live Streaming{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="bi bi-plus-square"></i> Create YouTube Broadcast</h2>
    <p class="text-muted">Create new live broadcast on YouTube</p>
</div>

{% if error_message %}
<!-- Error Alert -->
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <h5 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> YouTube API Not Available</h5>
    <p class="mb-0">{{ error_message }}</p>
    {% if 'client_secrets.json' in error_message %}
    <hr>
    <p class="mb-0 small">
        <strong>Setup Instructions:</strong><br>
        1. Go to <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a><br>
        2. Enable YouTube Data API v3<br>
        3. Create OAuth 2.0 credentials<br>
        4. Download as <code>client_secrets.json</code><br>
        5. Place in project root
    </p>
    {% endif %}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% else %}

<!-- Tabs -->
<!-- Single Broadcast Form -->
<div id="single">
    <form id="singleBroadcastForm">
        <div class="row">
            <!-- Left Column: Main Details -->
            <div class="col-lg-8">
                <!-- Card: Broadcast Details -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h5 class="card-title mb-0 text-primary"><i class="bi bi-pencil-square"></i> Broadcast Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Broadcast Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-lg" id="broadcastTitle" required
                                placeholder="e.g., Lofi Music 24/7 - Relaxing Beats">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="4"
                                placeholder="Describe your broadcast content..."></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Video Category</label>
                                    <select class="form-select" id="categoryId">
                                        <option value="10">Music</option>
                                        <option value="20">Gaming</option>
                                        <option value="24" selected>Entertainment</option>
                                        <option value="22">People & Blogs</option>
                                        <option value="27">Education</option>
                                        <option value="25">News & Politics</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tags</label>
                                    <input type="text" class="form-control" id="tags"
                                        placeholder="gaming, music, lofi (comma separated)">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Custom Thumbnail</label>
                            <input type="file" class="form-control" id="thumbnail" accept="image/*">
                            <div class="form-text">Recommended size: 1280x720 (16:9), max 2MB.</div>
                        </div>
                    </div>
                </div>

                <!-- Card: Auto-Stream Configuration -->
                <div class="card mb-4 border-primary shadow-sm">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="card-title mb-0"><i class="bi bi-robot"></i> Auto-Stream Configuration</h5>
                    </div>
                    <div class="card-body p-4 bg-light bg-opacity-25">

                        <!-- 1. Source Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold small text-muted text-uppercase mb-3">SOURCE</label>

                            <!-- Source Type Toggle -->
                            <div class="btn-group w-100 mb-3" role="group">
                                <input type="radio" class="btn-check" name="sourceMode" id="sourceVideo" value="single"
                                    checked onchange="toggleSource('single')">
                                <label class="btn btn-outline-primary" for="sourceVideo"><i class="bi bi-film"></i>
                                    Video File</label>

                                <input type="radio" class="btn-check" name="sourceMode" id="sourcePlaylist"
                                    value="playlist" onchange="toggleSource('single')">
                                <label class="btn btn-outline-primary" for="sourcePlaylist"><i
                                        class="bi bi-collection-play"></i> Playlist</label>
                            </div>

                            <!-- Source Input -->
                            <div id="videoSourceContainer">
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i
                                            class="bi bi-file-earmark-play"></i></span>
                                    <select class="form-select border-start-0" id="videoSourceId">
                                        <option value="">-- Choose a Video to Stream --</option>
                                        {% for video in videos %}
                                        <option value="{{ video.id }}">{{ video.name }} ({{ video.duration }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div id="playlistSourceContainer" style="display: none;">
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i
                                            class="bi bi-list-task"></i></span>
                                    <select class="form-select border-start-0" id="playlistSourceId">
                                        <option value="">-- Choose a Playlist --</option>
                                        {% for pl in playlists %}
                                        <option value="{{ pl.id }}">{{ pl.name }} ({{ pl.item_count }} items)
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <hr class="text-muted opacity-25 my-4">

                        <!-- 2. Loop & Options -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="loopPlayback" checked>
                                <label class="form-check-label fw-bold text-dark" for="loopPlayback">Loop Content
                                    Indefinitely</label>
                            </div>
                            <div class="form-text ms-4">Stream will automatically restart the video/playlist when it
                                finishes.</div>
                        </div>

                        <hr class="text-muted opacity-25 my-4">

                        <!-- 3. Broadcast Timing -->
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted text-uppercase mb-2">BROADCAST
                                TIMING</label>

                            <div class="btn-group mb-3" role="group">
                                <input type="radio" class="btn-check" name="timingMode" id="timingNow" value="now"
                                    checked onchange="toggleSchedule('single')">
                                <label class="btn btn-outline-success px-4" for="timingNow">
                                    <i class="bi bi-lightning-fill me-1"></i> Stream Now
                                </label>

                                <input type="radio" class="btn-check" name="timingMode" id="timingLater" value="later"
                                    onchange="toggleSchedule('single')">
                                <label class="btn btn-outline-primary px-4" for="timingLater">
                                    <i class="bi bi-calendar-event me-1"></i> Schedule
                                </label>
                            </div>

                            <!-- Schedule Fields (Hidden by default) -->
                            <div id="scheduleContainer" class="card bg-white border p-3 mb-3" style="display: none;">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold">Start Time</label>
                                        <input type="datetime-local" class="form-control" id="scheduledTime">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold">Recurrence</label>
                                        <select class="form-select" id="recurrence">
                                            <option value="none">One-time Event</option>
                                            <option value="daily">Daily</option>
                                            <option value="weekly">Weekly</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Stream Duration (Always Visible) -->
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted text-uppercase mb-1">STREAM
                                DURATION</label>
                            <select class="form-select" id="maxDurationHours">
                                <option value="0">24/7 (Unlimited)</option>
                                <option value="1">1 Hour</option>
                                <option value="3">3 Hours</option>
                                <option value="6">6 Hours</option>
                                <option value="12">12 Hours</option>
                                <option value="24">24 Hours</option>
                            </select>
                            <div class="form-text small mt-1">Siaran akan stop otomatis setelah durasi ini.</div>

                            <!-- Dynamic Help Text -->
                            <div id="scheduleHelpText" class="form-text text-success mt-1">
                                <i class="bi bi-lightning-charge"></i> Stream will start <strong>immediately</strong>
                                after creation.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Settings & Sidebar -->
            <div class="col-lg-4">
                <!-- Action Buttons (Top for easy access) -->
                <div class="d-grid gap-2 mb-4">
                    <button type="submit" class="btn btn-primary btn-lg shadow-sm" id="createSingleBtn">
                        <i class="bi bi-rocket-takeoff-fill me-2"></i> Create & Start
                    </button>
                    <a href="/admin/youtube/broadcasts" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </div>

                <!-- Card: Tech Specs -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h6 class="card-title mb-0 fw-bold text-muted text-uppercase small ls-1">Technical Settings</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Target Account</label>
                            <select class="form-select" id="accountId" required>
                                {% for account in youtube_accounts %}
                                <option value="{{ account.id }}">{{ account.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Stream Key Name</label>
                            <input type="text" class="form-control" id="streamName" required
                                placeholder="e.g., Main Stream 1080p">
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Privacy</label>
                            <select class="form-select" id="privacyStatus">
                                <option value="public">Public</option>
                                <option value="unlisted" selected>Unlisted</option>
                                <option value="private">Private</option>
                            </select>
                        </div>

                        <div class="row g-2">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">Quality</label>
                                    <select class="form-select form-select-sm" id="resolution">
                                        <option value="1080p" selected>1080p</option>
                                        <option value="720p">720p</option>
                                        <option value="480p">480p</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">FPS</label>
                                    <select class="form-select form-select-sm" id="frameRate">
                                        <option value="30fps" selected>30</option>
                                        <option value="60fps">60</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Latency</label>
                            <select class="form-select form-select-sm" id="latencyMode">
                                <option value="normal" selected>Normal (High Quality)</option>
                                <option value="low">Low (Interaction)</option>
                                <option value="ultraLow">Ultra Low (Real-time)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Card: Advanced Options -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3" data-bs-toggle="collapse" data-bs-target="#advancedOptions"
                        role="button" aria-expanded="false">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0 fw-bold text-muted text-uppercase small ls-1">Advanced Options
                            </h6>
                            <i class="bi bi-chevron-down small"></i>
                        </div>
                    </div>
                    <div class="collapse show" id="advancedOptions">
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Language</label>
                                <select class="form-select form-select-sm" id="language">
                                    <option value="id" selected>Indonesian</option>
                                    <option value="en">English</option>
                                    <option value="ja">Japanese</option>
                                    <option value="ko">Korean</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-bold">License</label>
                                <select class="form-select form-select-sm" id="license">
                                    <option value="youtube" selected>Standard YouTube</option>
                                    <option value="creativeCommon">Creative Commons</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-bold">Add to Playlist</label>
                                <select class="form-select form-select-sm" id="playlistId">
                                    <option value="">-- None --</option>
                                </select>
                            </div>

                            <hr class="my-3">

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enableChat" checked>
                                <label class="form-check-label small" for="enableChat">Enable Live Chat</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enableDvr" checked>
                                <label class="form-check-label small" for="enableDvr">Enable DVR</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="madeForKids">
                                <label class="form-check-label small" for="madeForKids">Made for Kids</label>
                            </div>

                            <hr class="my-3">

                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="autoStart" checked>
                                <label class="form-check-label small" for="autoStart">Auto Start Broadcast</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="autoStop" checked>
                                <label class="form-check-label small" for="autoStop">Auto Stop Broadcast</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Toggle Source Visibility
    function toggleSource(type) {
        // Only single mode supported for now
        const isPlaylist = document.getElementById('sourcePlaylist').checked;
        document.getElementById('videoSourceContainer').style.display = isPlaylist ? 'none' : 'block';
        document.getElementById('playlistSourceContainer').style.display = isPlaylist ? 'block' : 'none';
    }

    // Toggle Schedule Visibility
    function toggleSchedule(type) {
        const isLater = document.getElementById('timingLater').checked;
        document.getElementById('scheduleContainer').style.display = isLater ? 'block' : 'none';

        const helpText = document.getElementById('scheduleHelpText');
        if (isLater) {
            helpText.innerHTML = '<i class="bi bi-clock"></i> Stream will start automatically at the scheduled time.';
            helpText.className = "form-text text-primary mt-1";
        } else {
            document.getElementById('scheduledTime').value = '';
            helpText.innerHTML = '<i class="bi bi-lightning-charge"></i> Stream will start <strong>immediately</strong> after creation.';
            helpText.className = "form-text text-success mt-1";
        }
    }

    // Load Playlists
    async function loadPlaylists() {
        try {
            const response = await axios.get('/youtube/playlists');
            const playlists = response.data;
            const singleSelect = document.getElementById('playlistId');

            playlists.forEach(pl => {
                const option = new Option(pl.snippet.title, pl.id);
                singleSelect.add(option.cloneNode(true));
            });
        } catch (error) {
            console.error('Failed to load playlists', error);
        }
    }
    loadPlaylists();

    // Create Single Broadcast
    document.getElementById('singleBroadcastForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const btn = document.getElementById('createSingleBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating & configuring...';

        const formData = new FormData();
        formData.append('broadcast_title', document.getElementById('broadcastTitle').value);
        formData.append('stream_name', document.getElementById('streamName').value);
        formData.append('description', document.getElementById('description').value);
        formData.append('privacy_status', document.getElementById('privacyStatus').value);
        formData.append('resolution', document.getElementById('resolution').value);
        formData.append('frame_rate', document.getElementById('frameRate').value);
        formData.append('scheduled_start_time', document.getElementById('scheduledTime').value || '');
        formData.append('account_id', document.getElementById('accountId').value);
        formData.append('latency_mode', document.getElementById('latencyMode').value);
        formData.append('category_id', document.getElementById('categoryId').value);
        formData.append('enable_dvr', document.getElementById('enableDvr').checked);
        formData.append('made_for_kids', document.getElementById('madeForKids').checked);
        formData.append('enable_embed', false);
        formData.append('enable_chat', document.getElementById('enableChat').checked);
        formData.append('tags', document.getElementById('tags').value);
        formData.append('language', document.getElementById('language').value);
        formData.append('license', document.getElementById('license').value);
        formData.append('playlist_link_id', document.getElementById('playlistId').value); // Rename to distinguish from source
        formData.append('auto_start', document.getElementById('autoStart').checked);
        formData.append('auto_stop', document.getElementById('autoStop').checked);

        // Add Source & Timing Info
        const timingMode = document.querySelector('input[name="timingMode"]:checked').value;
        formData.append('timing_mode', timingMode);

        const sourceMode = document.querySelector('input[name="sourceMode"]:checked').value;
        formData.append('source_mode', sourceMode); // 'single' or 'playlist'

        if (sourceMode === 'single') {
            formData.append('video_id', document.getElementById('videoSourceId').value);
        } else {
            formData.append('source_playlist_id', document.getElementById('playlistSourceId').value);
        }
        formData.append('loop_playback', document.getElementById('loopPlayback').checked);

        // Add new params
        formData.append('max_duration_hours', document.getElementById('maxDurationHours').value);
        if (timingMode === 'later') {
            formData.append('recurrence', document.getElementById('recurrence').value);
        } else {
            formData.append('recurrence', 'none');
        }

        const thumbFile = document.getElementById('thumbnail').files[0];
        if (thumbFile) {
            formData.append('thumbnail', thumbFile);
        }

        try {
            const response = await axios.post('/youtube/create-live-setup', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            });

            showToast('Broadcast created & started successfully!', 'success');

            // Show success details
            const result = response.data;
            let msg = `Broadcast Created!\nID: ${result.broadcast_id}`;

            if (result.stream_started) {
                msg += '\n\n✅ Stream started automatically!';
            } else if (result.scheduled_job_id) {
                msg += '\n\n✅ Stream scheduled automatically!';
            }

            alert(msg);

            setTimeout(() => {
                window.location.href = '/admin/youtube/broadcasts';
            }, 1000);

        } catch (error) {
            console.error(error);
            showToast(error.response?.data?.detail || 'Failed to create broadcast', 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-plus-circle"></i> Create Broadcast';
        }
    });

</script>
{% endblock %}