{% extends "base.html" %}

{% block title %}Music Playlists - YouTube Live Streaming{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h2><i class="bi bi-music-note-list"></i> Music Playlists</h2>
        <p class="text-muted">Manage music playlists with video backgrounds for 24/7 streaming</p>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createMusicPlaylistModal">
        <i class="bi bi-plus-circle"></i> Create Music Playlist
    </button>
</div>

<!-- Music Playlists List -->
<div class="row g-4" id="playlistsContainer">
    <!-- Playlists will be loaded here via JavaScript -->
</div>

<!-- Create Music Playlist Modal -->
<div class="modal fade" id="createMusicPlaylistModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Music Playlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createMusicPlaylistForm">
                    <div class="row g-4">
                        <!-- Left Column: Settings -->
                        <div class="col-lg-6">
                            <!-- Basic Info Card -->
                            <div class="card mb-3 shadow-sm border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-uppercase text-muted small fw-bold mb-3">General Settings
                                    </h6>
                                    <div class="mb-3">
                                        <label class="form-label fw-medium">Playlist Name</label>
                                        <input type="text" class="form-control" id="playlistName"
                                            placeholder="e.g., Lofi Hip Hop Radio 24/7" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-medium">Playback Mode</label>
                                        <select class="form-select" id="playlistMode">
                                            <option value="sequence">Sequence (Play in order)</option>
                                            <option value="random">Random (Shuffle)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Visuals & Audio Card -->
                            <div class="card shadow-sm border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-uppercase text-muted small fw-bold mb-3">Visuals &
                                        Ambiance</h6>

                                    <!-- Video Background -->
                                    <div class="mb-4">
                                        <label class="form-label fw-medium">Video Background</label>
                                        <select class="form-select mb-1" id="videoBackground" required>
                                            <option value="">-- Select Video Background --</option>
                                        </select>
                                        <small class="text-muted d-block mb-2">
                                            <i class="bi bi-info-circle"></i> Use pre-encoded 1080p, 3000-5000kbps
                                            videos for efficiency.
                                        </small>
                                        <a href="/admin/media" target="_blank" class="text-decoration-none small"><i
                                                class="bi bi-folder"></i> Managed in Media Library</a>
                                    </div>

                                    <hr class="text-muted opacity-25">

                                    <!-- Sound Effect -->
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label fw-medium mb-0">Ambient Sound</label>
                                            <span class="badge bg-secondary rounded-pill">Optional</span>
                                        </div>

                                        <div class="input-group mb-3">
                                            <span class="input-group-text bg-white border-end-0"><i
                                                    class="bi bi-soundwave"></i></span>
                                            <select class="form-select border-start-0 ps-0" id="soundEffectSelect"
                                                onchange="updateDeleteButtonState('soundEffectSelect', 'deleteSoundEffectBtn')">
                                                <option value="">-- No Sound Effect --</option>
                                            </select>
                                            <label class="btn btn-outline-secondary" for="uploadSoundEffect"
                                                title="Upload New Sound">
                                                <i class="bi bi-upload"></i>
                                            </label>
                                            <input type="file" id="uploadSoundEffect" accept="audio/*"
                                                style="display: none;"
                                                onchange="handleSoundEffectUpload(event, 'soundEffectSelect')">
                                            <button type="button" class="btn btn-outline-danger"
                                                id="deleteSoundEffectBtn" title="Delete Selected Sound"
                                                onclick="deleteSoundEffect('soundEffectSelect')" disabled>
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>

                                        <label class="form-label small text-muted">Volume Mixing</label>
                                        <div class="d-flex align-items-center gap-3">
                                            <i class="bi bi-volume-down text-muted"></i>
                                            <input type="range" class="form-range flex-grow-1" id="soundEffectVolume"
                                                min="0" max="100" value="30"
                                                oninput="document.getElementById('soundEffectVolumeValue').textContent = this.value + '%'">
                                            <span class="badge bg-primary" style="width: 45px"
                                                id="soundEffectVolumeValue">30%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Music Selection -->
                        <div class="col-lg-6">
                            <div class="card h-100 shadow-sm border-0">
                                <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="card-title text-uppercase text-muted small fw-bold mb-0">Track
                                            Selection</h6>
                                        <div class="badge bg-light text-dark border">
                                            <span id="musicFilesCount">0 files</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <!-- Search & Filter -->
                                    <div class="row g-2 mb-3">
                                        <div class="col-7">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text bg-light border-end-0"><i
                                                        class="bi bi-search"></i></span>
                                                <input type="text" class="form-control border-start-0 ps-0"
                                                    id="createMusicSearch" placeholder="Search tracks..."
                                                    onkeyup="filterMusicFiles()">
                                            </div>
                                        </div>
                                        <div class="col-5">
                                            <select class="form-select form-select-sm" id="createCategoryFilter"
                                                onchange="filterMusicFiles()">
                                                <option value="">All Categories</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Quick Actions -->
                                    <div class="d-flex gap-2 mb-2">
                                        <button type="button" class="btn btn-xs btn-outline-primary flex-fill"
                                            onclick="selectAllVisibleMusic()">
                                            <i class="bi bi-check-all"></i> Select Visible
                                        </button>
                                        <button type="button" class="btn btn-xs btn-outline-secondary flex-fill"
                                            onclick="deselectAllMusic()">
                                            <i class="bi bi-x"></i> Clear Selection
                                        </button>
                                    </div>

                                    <!-- File List -->
                                    <div class="border rounded-3 flex-grow-1 bg-light p-2"
                                        style="max-height: 400px; overflow-y: auto; min-height: 300px;"
                                        id="musicFilesContainer">
                                        <p class="text-muted text-center my-5">Loading music files...</p>
                                    </div>

                                    <div class="mt-3 text-center">
                                        <a href="/admin/music-library" target="_blank"
                                            class="text-decoration-none small text-muted">
                                            <i class="bi bi-plus-circle"></i> Add more tracks in Music Library
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary px-4" onclick="createMusicPlaylist()">
                    <i class="bi bi-save"></i> Create Playlist
                </button>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Start Streaming Modal -->
<div class="modal fade" id="startStreamModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start Music Playlist Stream</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="startStreamForm">
                    <input type="hidden" id="streamPlaylistId">

                    <div class="mb-3">
                        <label class="form-label">Playlist</label>
                        <input type="text" class="form-control" id="streamPlaylistName" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Select Stream Key</label>
                        <select class="form-select" id="streamKeySelect" required>
                            <option value="">-- Select Stream Key --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Stream Duration</label>
                        <select class="form-select" id="streamDuration">
                            <option value="0">24/7 (Unlimited)</option>
                            <option value="1">1 Hour</option>
                            <option value="3">3 Hours</option>
                            <option value="6">6 Hours</option>
                            <option value="12">12 Hours</option>
                            <option value="24">24 Hours</option>
                        </select>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-cpu"></i> <strong>Optimized Streaming:</strong>
                        This will use minimal CPU (10-20%) thanks to pre-encoded video background.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="startMusicStream()">
                    <i class="bi bi-broadcast"></i> Start Stream
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Stream Modal -->
<div class="modal fade" id="scheduleStreamModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule Music Playlist Stream</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleStreamForm">
                    <input type="hidden" id="schedulePlaylistId">

                    <div class="mb-3">
                        <label class="form-label">Playlist</label>
                        <input type="text" class="form-control" id="schedulePlaylistName" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Select Stream Key</label>
                        <select class="form-select" id="scheduleStreamKeySelect" required>
                            <option value="">-- Select Stream Key --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Scheduled Date & Time</label>
                        <input type="datetime-local" class="form-control" id="scheduledTime" required>
                        <div class="form-text">Select when to start the stream</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Stream Duration</label>
                        <select class="form-select" id="scheduleDuration">
                            <option value="0">24/7 (Unlimited)</option>
                            <option value="1">1 Hour</option>
                            <option value="3">3 Hours</option>
                            <option value="6">6 Hours</option>
                            <option value="12">12 Hours</option>
                            <option value="24">24 Hours</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Recurrence</label>
                        <select class="form-select" id="scheduleRecurrence">
                            <option value="none">No Repeat</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                        </select>
                        <div class="form-text">Automatically repeat this schedule</div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> The stream will start automatically at the scheduled time.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="scheduleMusicStream()">
                    <i class="bi bi-calendar-check"></i> Schedule Stream
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Music Playlist Modal -->
<div class="modal fade" id="editMusicPlaylistModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Music Playlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMusicPlaylistForm">
                    <input type="hidden" id="editPlaylistId">
                    <div class="row g-4">
                        <!-- Left Column: Settings -->
                        <div class="col-lg-6">
                            <!-- Basic Info Card -->
                            <div class="card mb-3 shadow-sm border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-uppercase text-muted small fw-bold mb-3">General Settings
                                    </h6>
                                    <div class="mb-3">
                                        <label class="form-label fw-medium">Playlist Name</label>
                                        <input type="text" class="form-control" id="editPlaylistName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-medium">Playback Mode</label>
                                        <select class="form-select" id="editPlaylistMode">
                                            <option value="sequence">Sequence (Play in order)</option>
                                            <option value="random">Random (Shuffle)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Visuals & Audio Card -->
                            <div class="card shadow-sm border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-uppercase text-muted small fw-bold mb-3">Visuals &
                                        Ambiance</h6>

                                    <!-- Video Background -->
                                    <div class="mb-4">
                                        <label class="form-label fw-medium">Video Background</label>
                                        <select class="form-select mb-1" id="editVideoBackground" required>
                                            <option value="">-- Select Video Background --</option>
                                        </select>
                                    </div>

                                    <hr class="text-muted opacity-25">

                                    <!-- Sound Effect -->
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label fw-medium mb-0">Ambient Sound</label>
                                            <span class="badge bg-secondary rounded-pill">Optional</span>
                                        </div>

                                        <div class="input-group mb-3">
                                            <span class="input-group-text bg-white border-end-0"><i
                                                    class="bi bi-soundwave"></i></span>
                                            <select class="form-select border-start-0 ps-0" id="editSoundEffectSelect"
                                                onchange="updateDeleteButtonState('editSoundEffectSelect', 'deleteEditSoundEffectBtn')">
                                                <option value="">-- No Sound Effect --</option>
                                            </select>
                                            <label class="btn btn-outline-secondary" for="uploadEditSoundEffect"
                                                title="Upload New Sound">
                                                <i class="bi bi-upload"></i>
                                            </label>
                                            <input type="file" id="uploadEditSoundEffect" accept="audio/*"
                                                style="display: none;"
                                                onchange="handleSoundEffectUpload(event, 'editSoundEffectSelect')">
                                            <button type="button" class="btn btn-outline-danger"
                                                id="deleteEditSoundEffectBtn" title="Delete Selected Sound"
                                                onclick="deleteSoundEffect('editSoundEffectSelect')" disabled>
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>

                                        <label class="form-label small text-muted">Volume Mixing</label>
                                        <div class="d-flex align-items-center gap-3">
                                            <i class="bi bi-volume-down text-muted"></i>
                                            <input type="range" class="form-range flex-grow-1"
                                                id="editSoundEffectVolume" min="0" max="100" value="30"
                                                oninput="document.getElementById('editSoundEffectVolumeValue').textContent = this.value + '%'">
                                            <span class="badge bg-primary" style="width: 45px"
                                                id="editSoundEffectVolumeValue">30%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Music Selection -->
                        <div class="col-lg-6">
                            <div class="card h-100 shadow-sm border-0">
                                <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="card-title text-uppercase text-muted small fw-bold mb-0">Track
                                            Selection</h6>
                                        <div class="badge bg-light text-dark border">
                                            <span id="editMusicFileCount">Select tracks</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <!-- Search & Filter -->
                                    <div class="row g-2 mb-3">
                                        <div class="col-7">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text bg-light border-end-0"><i
                                                        class="bi bi-search"></i></span>
                                                <input type="text" class="form-control border-start-0 ps-0"
                                                    id="editMusicSearch" placeholder="Search tracks..."
                                                    onkeyup="filterEditMusicFiles()">
                                            </div>
                                        </div>
                                        <div class="col-5">
                                            <select class="form-select form-select-sm" id="editCategoryFilter"
                                                onchange="filterEditMusicFiles()">
                                                <option value="">All Categories</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Quick Actions -->
                                    <div class="d-flex gap-2 mb-2">
                                        <button type="button" class="btn btn-xs btn-outline-primary flex-fill"
                                            onclick="selectAllVisibleEditMusic()">
                                            <i class="bi bi-check-all"></i> Select Visible
                                        </button>
                                        <button type="button" class="btn btn-xs btn-outline-secondary flex-fill"
                                            onclick="deselectAllEditMusic()">
                                            <i class="bi bi-x"></i> Clear Selection
                                        </button>
                                    </div>

                                    <div class="alert alert-light border small text-muted mb-2">
                                        <i class="bi bi-info-circle"></i> Check/uncheck boxes to modify selection.
                                    </div>

                                    <!-- File List -->
                                    <div class="border rounded-3 flex-grow-1 bg-light p-2"
                                        style="max-height: 400px; overflow-y: auto; min-height: 300px;"
                                        id="editMusicFilesContainer">
                                        <p class="text-muted text-center my-5">Loading music files...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateMusicPlaylist()">
                    <i class="bi bi-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let musicPlaylists = [];
    let musicFiles = [];
    let backgroundVideos = [];
    let soundEffects = [];
    let streamKeys = [];

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadMusicPlaylists();
        loadMusicFiles();
        loadBackgroundVideos();

        loadSoundEffects();
        loadStreamKeys();
    });

    // Load music playlists
    async function loadMusicPlaylists() {
        try {
            const response = await axios.get('/music-playlists/');
            musicPlaylists = response.data;
            renderPlaylists();
        } catch (error) {
            console.error('Error loading music playlists:', error);
            showToast('Failed to load music playlists', 'danger');
        }
    }

    // Render playlists
    function renderPlaylists() {
        const container = document.getElementById('playlistsContainer');

        if (musicPlaylists.length === 0) {
            container.innerHTML = `
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                            <p class="text-muted mt-3">No music playlists found</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createMusicPlaylistModal">
                                <i class="bi bi-plus-circle"></i> Create Your First Music Playlist
                            </button>
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        container.innerHTML = musicPlaylists.map(playlist => `
            <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                    <div class="card-header bg-primary bg-opacity-10">
                        <h5 class="mb-0"><i class="bi bi-music-note-list"></i> ${playlist.name}</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <span class="badge bg-info me-2">
                                <i class="bi bi-music-note"></i> ${playlist.music_count} songs
                            </span>
                            <span class="badge bg-secondary">
                                <i class="bi bi-shuffle"></i> ${playlist.mode}
                            </span>
                        </div>

                        <p class="text-muted small mb-3">
                            <i class="bi bi-film"></i> Background: ${getFilename(playlist.video_background_path)}
                        </p>

                        <p class="text-muted small mb-3">
                            Created: ${new Date(playlist.created_at).toLocaleString()}
                        </p>

                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-success" onclick="openStartStreamModal(${playlist.id}, '${playlist.name}')">
                                <i class="bi bi-broadcast"></i> Start Live
                            </button>
                            <button class="btn btn-sm btn-info" onclick="openScheduleStreamModal(${playlist.id}, '${playlist.name}')">
                                <i class="bi bi-calendar-event"></i> Schedule
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="openEditPlaylistModal(${playlist.id})">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="cloneMusicPlaylist(${playlist.id}, '${playlist.name}')">
                                <i class="bi bi-files"></i> Clone
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMusicPlaylist(${playlist.id}, '${playlist.name}')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Load music files
    async function loadMusicFiles() {
        try {
            // Try Music Library API first
            const response = await axios.get('/music-files/', { params: { limit: 1000 } });
            musicFiles = response.data.music_files || [];

            // Load categories
            const catResponse = await axios.get('/categories/');
            const categories = catResponse.data || [];

            // Populate category filter
            const categoryFilter = document.getElementById('createCategoryFilter');
            const editCategoryFilter = document.getElementById('editCategoryFilter');

            const categoryOptions = '<option value="">All Categories</option>' +
                categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');

            if (categoryFilter) categoryFilter.innerHTML = categoryOptions;
            if (editCategoryFilter) editCategoryFilter.innerHTML = categoryOptions;

            renderMusicFiles();
        } catch (error) {
            console.error('Error loading from Music Library, trying fallback:', error);
            // Fallback to old method
            try {
                const response = await axios.get('/music/list');
                musicFiles = response.data.files || [];
                renderMusicFiles();
            } catch (fallbackError) {
                console.error('Fallback also failed:', fallbackError);
            }
        }
    }

    // Render music files
    function renderMusicFiles() {
        const container = document.getElementById('musicFilesContainer');

        if (musicFiles.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No music files available.</p>';
            return;
        }

        container.innerHTML = `<div class="list-group list-group-flush">` + musicFiles.map((file, index) => {
            const categoryBadge = file.category_name ?
                `<span class="badge rounded-pill bg-light text-dark border ms-2 small">${file.category_name}</span>` : '';
            const duration = file.duration ? formatDuration(file.duration) : '';
            const size = file.file_size || file.size;
            const path = file.file_path || file.path;

            return `
                <label class="list-group-item list-group-item-action music-file-item d-flex align-items-center gap-3 py-2 border-0 rounded mb-1 ${index % 2 === 0 ? 'bg-white' : 'bg-light'}" 
                    style="cursor: pointer;"
                    data-filename="${file.filename.toLowerCase()}" 
                    data-category="${file.category_id || ''}">
                    <input class="form-check-input music-file-checkbox flex-shrink-0 my-0" type="checkbox" value="${path}" id="music${index}" style="width: 1.2rem; height: 1.2rem;">
                    <div class="flex-grow-1 min-w-0">
                        <div class="d-flex justify-content-between align-items-baseline">
                            <span class="fw-medium text-truncate" title="${file.filename}">${file.filename}</span>
                            ${categoryBadge}
                        </div>
                        <div class="small text-muted d-flex gap-2">
                            <span><i class="bi bi-clock"></i> ${duration || '--:--'}</span>
                            <span><i class="bi bi-hdd"></i> ${formatFileSize(size)}</span>
                        </div>
                    </div>
                </label>
            `;
        }).join('') + `</div>`;

        updateMusicCount();
    }

    // Update music count (Create Modal)
    function updateMusicCount() {
        // Scoped to create music container
        const total = musicFiles.length;
        const visible = document.querySelectorAll('#musicFilesContainer .music-file-item:not([style*="display: none"])').length;
        const countEl = document.getElementById('musicFilesCount');
        if (countEl) {
            countEl.textContent = visible < total ? `Showing ${visible} of ${total} files` : `${total} files`;
        }
    }

    // Update Edit music count
    function updateEditMusicCount() {
        const total = musicFiles.length;
        // Scoped to edit music container
        const visible = document.querySelectorAll('#editMusicFilesContainer .music-file-item:not([style*="display: none"])').length;
        const countEl = document.getElementById('editMusicFileCount');
        if (countEl) {
            countEl.textContent = visible < total ? `Showing ${visible} of ${total} files` : `${total} files`;
        }
    }

    // Filter music files (Create Modal)
    function filterMusicFiles() {
        const searchTerm = document.getElementById('createMusicSearch')?.value.toLowerCase() || '';
        const categoryId = document.getElementById('createCategoryFilter')?.value || '';
        // Scoped to create container
        const items = document.querySelectorAll('#musicFilesContainer .music-file-item');

        items.forEach(item => {
            const filename = item.getAttribute('data-filename');
            const itemCategory = item.getAttribute('data-category');

            const matchesSearch = !searchTerm || filename.includes(searchTerm);
            const matchesCategory = !categoryId || itemCategory === String(categoryId);

            item.style.display = (matchesSearch && matchesCategory) ? 'block' : 'none';
        });

        updateMusicCount();
    }

    // Filter Edit Music Files
    function filterEditMusicFiles() {
        const searchTerm = document.getElementById('editMusicSearch')?.value.toLowerCase() || '';
        const categoryId = document.getElementById('editCategoryFilter')?.value || '';
        // Scoped to edit container
        const items = document.querySelectorAll('#editMusicFilesContainer .music-file-item');

        items.forEach(item => {
            const filename = item.getAttribute('data-filename');
            const itemCategory = item.getAttribute('data-category');

            const matchesSearch = !searchTerm || filename.includes(searchTerm);
            const matchesCategory = !categoryId || itemCategory === String(categoryId);

            item.style.display = (matchesSearch && matchesCategory) ? 'block' : 'none';
        });

        updateEditMusicCount();
    }

    // Select all visible music (Create Modal)
    function selectAllVisibleMusic() {
        document.querySelectorAll('#musicFilesContainer .music-file-item').forEach(item => {
            if (item.style.display !== 'none') {
                const checkbox = item.querySelector('.music-file-checkbox');
                if (checkbox) checkbox.checked = true;
            }
        });
    }

    // Select all visible music (Edit Modal)
    function selectAllVisibleEditMusic() {
        document.querySelectorAll('#editMusicFilesContainer .music-file-item').forEach(item => {
            if (item.style.display !== 'none') {
                const checkbox = item.querySelector('.edit-music-file-checkbox');
                if (checkbox) checkbox.checked = true;
            }
        });
    }

    // Format duration
    function formatDuration(seconds) {
        if (!seconds) return '';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Load background videos
    async function loadBackgroundVideos() {
        try {
            const response = await axios.get('/backgrounds/list');
            backgroundVideos = response.data.files || [];
            renderBackgroundVideos();
        } catch (error) {
            console.error('Error loading background videos:', error);
        }
    }

    // Render background videos
    function renderBackgroundVideos() {
        const select = document.getElementById('videoBackground');

        if (backgroundVideos.length === 0) {
            select.innerHTML = '<option value="">No backgrounds available - upload one first</option>';
            return;
        }

        select.innerHTML = '<option value="">-- Select Video Background --</option>' +
            backgroundVideos.map(file => `
                <option value="${file.path}">${file.filename} (${formatFileSize(file.size)})</option>
            `).join('');
    }

    // Load stream keys
    async function loadStreamKeys() {
        try {
            const response = await axios.get('/dashboard/stream-keys/api');
            streamKeys = response.data;
            console.log('Stream keys loaded:', streamKeys);
            renderStreamKeys();
        } catch (error) {
            console.error('Error loading stream keys:', error);
            // Don't show toast - stream keys are optional
            streamKeys = [];
            renderStreamKeys();
        }
    }

    // Render stream keys
    function renderStreamKeys() {
        const select = document.getElementById('streamKeySelect');

        if (streamKeys.length === 0) {
            select.innerHTML = '<option value="">No stream keys available</option>';
            return;
        }

        select.innerHTML = '<option value="">-- Select Stream Key --</option>' +
            streamKeys.map(key => `
                <option value="${key.id}">${key.name}</option>
            `).join('');
    }

    // Upload background video
    document.getElementById('uploadBackground').addEventListener('change', async function (e) {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
            showToast('Uploading background video...', 'info');
            await axios.post('/upload/background', formData);
            showToast('Background video uploaded successfully!', 'success');
            loadBackgroundVideos();
            e.target.value = '';
        } catch (error) {
            showToast(error.response?.data?.detail || 'Failed to upload background video', 'danger');
        }
    });

    // Load Sound Effects
    async function loadSoundEffects() {
        try {
            const response = await axios.get('/sound-effects/list');
            soundEffects = response.data.files || [];
            renderSoundEffects();
        } catch (error) {
            console.error('Error loading sound effects:', error);
        }
    }

    // Render Sound Effects
    function renderSoundEffects() {
        const createSelect = document.getElementById('soundEffectSelect');
        const editSelect = document.getElementById('editSoundEffectSelect');

        const options = '<option value="">-- No Sound Effect --</option>' +
            soundEffects.map(file => `
                <option value="${file.path}">${file.filename} (${formatFileSize(file.size)})</option>
            `).join('');

        if (createSelect) createSelect.innerHTML = options;
        if (editSelect) editSelect.innerHTML = options;
    }

    // Create Uploader
    // Event listeners moved to inline onchange attribute for robustness
    /*
    document.addEventListener('DOMContentLoaded', function () {
        const uploadCreate = document.getElementById('uploadSoundEffect');
        const uploadEdit = document.getElementById('uploadEditSoundEffect');

        if (uploadCreate) {
            uploadCreate.addEventListener('change', (e) => handleSoundEffectUpload(e, 'soundEffectSelect'));
        }
        if (uploadEdit) {
            uploadEdit.addEventListener('change', (e) => handleSoundEffectUpload(e, 'editSoundEffectSelect'));
        }
    });
    */

    async function handleSoundEffectUpload(e, selectId) {
        console.log('--- HANDLE SOUND EFFECT UPLOAD STARTED ---');
        console.log('Event:', e);
        console.log('Select ID:', selectId);

        const file = e.target.files[0];
        console.log('Selected File:', file);

        if (!file) {
            console.error('No file selected! Return.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        console.log('FormData created. Appending file:', file.name);

        try {
            console.log('Sending POST request to /upload/sound-effect...');
            showToast('Uploading sound effect...', 'info');

            const response = await axios.post('/upload/sound-effect', formData);
            console.log('Response received:', response);
            console.log('Response status:', response.status);
            console.log('Response data:', response.data);

            if (response.data.success) {
                showToast('Sound effect uploaded successfully!', 'success');
                console.log('Upload success. Reloading list...');

                // Reload list to ensure new file is in the options
                await loadSoundEffects();
                console.log('List reloaded.');

                const uploadedPath = response.data.path;
                console.log('Uploaded Path:', uploadedPath);

                const select = document.getElementById(selectId);
                console.log('Found Select Element:', select);

                if (select && uploadedPath) {
                    console.log('Attempting to select uploaded file...');
                    // No need to manually create option as loadSoundEffects() already refreshed the list from server.
                    // We just need to find it and select it.

                    let option = select.querySelector(`option[value="${uploadedPath}"]`);
                    console.log('Found Option after reload:', option);

                    if (option) {
                        select.value = uploadedPath;
                        console.log('Select value set to:', select.value);
                        select.dispatchEvent(new Event('change'));
                    } else {
                        console.warn('Option not found even after reload. This is unexpected.');
                    }
                } else {
                    console.error('FAILED TO SELECT: Select element not found or path missing.');
                }
            } else {
                console.error('Upload reported failure:', response.data);
                showToast('Upload failed: ' + (response.data.message || 'Unknown error'), 'danger');
            }

            e.target.value = '';
        } catch (error) {
            console.error('--- UPLOAD ERROR ---', error);
            console.error('Error Details:', error.response?.data);
            showToast(error.response?.data?.detail || 'Failed to upload sound effect', 'danger');
        }
    }

    // Upload music files
    document.getElementById('uploadMusic').addEventListener('change', async function (e) {
        const files = e.target.files;
        if (!files.length) return;

        for (let file of files) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                showToast(`Uploading ${file.name}...`, 'info');
                await axios.post('/upload/music', formData);
                showToast(`${file.name} uploaded successfully!`, 'success');
            } catch (error) {
                showToast(error.response?.data?.detail || `Failed to upload ${file.name}`, 'danger');
            }
        }

        loadMusicFiles();
        e.target.value = '';
    });

    // Create music playlist
    async function createMusicPlaylist() {
        const name = document.getElementById('playlistName').value;
        const mode = document.getElementById('playlistMode').value;

        const videoBackground = document.getElementById('videoBackground').value;
        const soundEffectPath = document.getElementById('soundEffectSelect').value || null;
        const soundEffectVolume = document.getElementById('soundEffectVolume').value / 100;

        // Get selected music files
        const checkboxes = document.querySelectorAll('.music-file-checkbox:checked');
        const musicFiles = Array.from(checkboxes).map(cb => cb.value);

        if (!name) {
            showToast('Please enter playlist name', 'danger');
            return;
        }

        if (!videoBackground) {
            showToast('Please select a video background', 'danger');
            return;
        }

        if (musicFiles.length === 0) {
            showToast('Please select at least one music file', 'danger');
            return;
        }

        try {
            await axios.post('/music-playlists/', {
                name: name,
                video_background_path: videoBackground,
                music_files: musicFiles,

                mode: mode,
                sound_effect_path: soundEffectPath,
                sound_effect_volume: soundEffectVolume
            });

            showToast('Music playlist created successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createMusicPlaylistModal')).hide();
            loadMusicPlaylists();

            // Reset form
            document.getElementById('createMusicPlaylistForm').reset();
        } catch (error) {
            showToast(error.response?.data?.detail || 'Failed to create music playlist', 'danger');
        }
    }

    // Open start stream modal
    function openStartStreamModal(playlistId, playlistName) {
        document.getElementById('streamPlaylistId').value = playlistId;
        document.getElementById('streamPlaylistName').value = playlistName;
        new bootstrap.Modal(document.getElementById('startStreamModal')).show();
    }

    // Start music stream
    async function startMusicStream() {
        const playlistId = document.getElementById('streamPlaylistId').value;
        const streamKeyId = document.getElementById('streamKeySelect').value;
        const duration = document.getElementById('streamDuration').value;

        if (!streamKeyId) {
            showToast('Please select a stream key', 'danger');
            return;
        }

        try {
            // TODO: Create endpoint to start music playlist stream
            showToast('Starting music playlist stream...', 'info');

            // This will need a new endpoint in live.py router
            await axios.post('/live/music-playlist', {
                music_playlist_id: parseInt(playlistId),
                stream_key_id: parseInt(streamKeyId),
                max_duration_hours: parseInt(duration)
            });

            showToast('Music playlist stream started successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('startStreamModal')).hide();

            setTimeout(() => window.location.href = '/dashboard/monitoring', 1000);
        } catch (error) {
            showToast(error.response?.data?.detail || 'Failed to start stream', 'danger');
        }
    }

    // Delete music playlist
    async function deleteMusicPlaylist(playlistId, name) {
        if (!confirm(`Delete music playlist "${name}"?`)) return;

        try {
            await axios.delete(`/music-playlists/${playlistId}`);
            showToast('Music playlist deleted!', 'success');
            loadMusicPlaylists();
        } catch (error) {
            showToast(error.response?.data?.detail || 'Failed to delete music playlist', 'danger');
        }
    }


    // Clone music playlist
    async function cloneMusicPlaylist(playlistId, name) {
        try {
            const response = await axios.get(`/music-playlists/${playlistId}`);
            const playlist = response.data;

            await axios.post('/music-playlists/', {
                name: `${playlist.name} (Copy)`,
                video_background_path: playlist.video_background_path,
                music_files: playlist.music_files,
                mode: playlist.mode
            });

            showToast('Music playlist cloned successfully!', 'success');
            loadMusicPlaylists();
        } catch (error) {
            showToast(error.response?.data?.detail || 'Failed to clone music playlist', 'danger');
        }
    }

    // Open schedule stream modal
    function openScheduleStreamModal(playlistId, playlistName) {
        document.getElementById('schedulePlaylistId').value = playlistId;
        document.getElementById('schedulePlaylistName').value = playlistName;

        // Populate stream keys in schedule modal
        const select = document.getElementById('scheduleStreamKeySelect');
        if (streamKeys.length === 0) {
            select.innerHTML = '<option value="">No stream keys available</option>';
        } else {
            select.innerHTML = '<option value="">-- Select Stream Key --</option>' +
                streamKeys.map(key => `
                    <option value="${key.id}">${key.name}</option>
                `).join('');
        }

        // Set minimum datetime to now
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('scheduledTime').min = now.toISOString().slice(0, 16);

        new bootstrap.Modal(document.getElementById('scheduleStreamModal')).show();
    }

    // Schedule music stream
    async function scheduleMusicStream() {
        const playlistId = document.getElementById('schedulePlaylistId').value;
        const streamKeyId = document.getElementById('scheduleStreamKeySelect').value;
        const scheduledTime = document.getElementById('scheduledTime').value;
        const duration = document.getElementById('scheduleDuration').value;
        const recurrence = document.getElementById('scheduleRecurrence').value;

        if (!streamKeyId) {
            showToast('Please select a stream key', 'danger');
            return;
        }

        if (!scheduledTime) {
            showToast('Please select scheduled date & time', 'danger');
            return;
        }

        try {
            showToast('Scheduling music playlist stream...', 'info');

            await axios.post('/live/schedule-music-playlist', {
                music_playlist_id: parseInt(playlistId),
                stream_key_id: parseInt(streamKeyId),
                scheduled_time: scheduledTime,
                max_duration_hours: parseInt(duration),
                recurrence: recurrence
            });

            showToast('Music playlist stream scheduled successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('scheduleStreamModal')).hide();

            setTimeout(() => window.location.href = '/admin/scheduler', 1000);
        } catch (error) {
            showToast(error.response?.data?.detail || 'Failed to schedule stream', 'danger');
        }
    }

    // Open edit playlist modal
    async function openEditPlaylistModal(playlistId) {
        try {
            // Get playlist data
            const response = await axios.get(`/music-playlists/${playlistId}`);
            const playlist = response.data;

            // Populate form
            document.getElementById('editPlaylistId').value = playlist.id;
            document.getElementById('editPlaylistName').value = playlist.name;
            document.getElementById('editPlaylistMode').value = playlist.mode;

            // Populate video background dropdown
            document.getElementById('editPlaylistId').value = playlist.id;
            document.getElementById('editPlaylistName').value = playlist.name;
            document.getElementById('editPlaylistMode').value = playlist.mode;

            // Populate sound effect
            document.getElementById('editSoundEffectSelect').value = playlist.sound_effect_path || "";
            const vol = Math.round((playlist.sound_effect_volume || 0.3) * 100);
            document.getElementById('editSoundEffectVolume').value = vol;
            document.getElementById('editSoundEffectVolumeValue').textContent = vol + '%';

            // Update delete button state explicitly
            updateDeleteButtonState('editSoundEffectSelect', 'deleteEditSoundEffectBtn');

            // Populate video background dropdown
            const bgSelect = document.getElementById('editVideoBackground');
            if (backgroundVideos.length === 0) {
                bgSelect.innerHTML = '<option value="">No backgrounds available</option>';
            } else {
                bgSelect.innerHTML = '<option value="">-- Select Video Background --</option>' +
                    backgroundVideos.map(file => `
                        <option value="${file.path}" ${file.path === playlist.video_background_path ? 'selected' : ''}>
                            ${file.filename} (${formatFileSize(file.size)})
                        </option>
                    `).join('');
            }

            // Populate music files with current selection
            const container = document.getElementById('editMusicFilesContainer');
            if (musicFiles.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No music files available</p>';
            } else {
                container.innerHTML = `<div class="list-group list-group-flush">` + musicFiles.map((file, index) => {
                    const path = file.file_path || file.path;
                    const size = file.file_size || file.size;
                    const isSelected = playlist.music_files.includes(path);
                    const categoryBadge = file.category_name ?
                        `<span class="badge rounded-pill bg-light text-dark border ms-2 small">${file.category_name}</span>` : '';
                    const duration = file.duration ? formatDuration(file.duration) : '';

                    return `
                        <label class="list-group-item list-group-item-action music-file-item d-flex align-items-center gap-3 py-2 border-0 rounded mb-1 ${index % 2 === 0 ? 'bg-white' : 'bg-light'}" 
                            style="cursor: pointer;"
                            data-filename="${file.filename.toLowerCase()}" 
                            data-category="${file.category_id || ''}">
                            <input class="form-check-input edit-music-file-checkbox flex-shrink-0 my-0" type="checkbox" 
                                   value="${path}" id="editMusic${index}" ${isSelected ? 'checked' : ''} style="width: 1.2rem; height: 1.2rem;">
                            <div class="flex-grow-1 min-w-0">
                                <div class="d-flex justify-content-between align-items-baseline">
                                    <span class="fw-medium text-truncate" title="${file.filename}">${file.filename}</span>
                                    ${categoryBadge}
                                </div>
                                <div class="small text-muted d-flex gap-2">
                                    <span><i class="bi bi-clock"></i> ${duration || '--:--'}</span>
                                    <span><i class="bi bi-hdd"></i> ${formatFileSize(size)}</span>
                                </div>
                            </div>
                        </label>
                    `;
                }).join('') + `</div>`;
            }

            // Show modal
            new bootstrap.Modal(document.getElementById('editMusicPlaylistModal')).show();

            // Update count
            updateEditMusicCount();

        } catch (error) {
            console.error('Error loading playlist:', error);
            showToast(error.response?.data?.detail || 'Failed to load playlist data', 'danger');
        }
    }

    // Update music playlist
    async function updateMusicPlaylist() {
        const playlistId = document.getElementById('editPlaylistId').value;
        const name = document.getElementById('editPlaylistName').value;
        const mode = document.getElementById('editPlaylistMode').value;
        const videoBackground = document.getElementById('editVideoBackground').value;
        const soundEffectPath = document.getElementById('editSoundEffectSelect').value || null;
        const soundEffectVolume = document.getElementById('editSoundEffectVolume').value / 100;

        // Get selected music files
        const checkboxes = document.querySelectorAll('.edit-music-file-checkbox:checked');
        const musicFiles = Array.from(checkboxes).map(cb => cb.value);

        if (!name) {
            showToast('Please enter playlist name', 'danger');
            return;
        }

        if (!videoBackground) {
            showToast('Please select a video background', 'danger');
            return;
        }

        if (musicFiles.length === 0) {
            showToast('Please select at least one music file', 'danger');
            return;
        }

        try {
            await axios.put(`/music-playlists/${playlistId}`, {
                name: name,
                video_background_path: videoBackground,
                music_files: musicFiles,
                mode: mode,
                sound_effect_path: soundEffectPath,
                sound_effect_volume: soundEffectVolume
            });

            showToast('Music playlist updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editMusicPlaylistModal')).hide();
            loadMusicPlaylists();
        } catch (error) {
            showToast(error.response?.data?.detail || 'Failed to update music playlist', 'danger');
        }
    }

    // Helper function to get filename from path
    function getFilename(path) {
        return path.split(/[/\\]/).pop();
    }

    // Clone music playlist
    async function cloneMusicPlaylist(playlistId, name) {
        if (!confirm(`Clone playlist "${name}"?\n\nThis will create a copy with all settings and music files.`)) return;

        try {
            // Get original playlist
            const response = await axios.get(`/music-playlists/${playlistId}`);
            const original = response.data;

            // Create clone with " (Copy)" suffix
            await axios.post('/music-playlists/', {
                name: original.name + ' (Copy)',
                video_background_path: original.video_background_path,
                music_files: original.music_files,
                mode: original.mode,
                sound_effect_path: original.sound_effect_path,
                sound_effect_volume: original.sound_effect_volume
            });

            showToast('Playlist cloned successfully!', 'success');
            loadMusicPlaylists();
        } catch (error) {
            showToast(error.response?.data?.detail || 'Failed to clone playlist', 'danger');
        }
    }

    // Select all music files
    function selectAllMusic() {
        const checkboxes = document.querySelectorAll('.music-file-checkbox');
        checkboxes.forEach(cb => cb.checked = true);
    }

    // Deselect all music files (Create Modal)
    function deselectAllMusic() {
        const checkboxes = document.querySelectorAll('.music-file-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
    }

    // Deselect all music files (Edit Modal)
    function deselectAllEditMusic() {
        const checkboxes = document.querySelectorAll('.edit-music-file-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
    }

    // --- Delete Sound Effect Logic ---
    async function deleteSoundEffect(selectId) {
        const select = document.getElementById(selectId);
        const filePath = select.value;

        if (!filePath) {
            showToast('Please select a sound effect to delete', 'warning');
            return;
        }

        // Get filename from path for display
        const filename = filePath.split(/[/\\]/).pop();

        if (!confirm(`Are you sure you want to delete "${filename}"? This action cannot be undone.`)) {
            return;
        }

        try {
            await axios.delete(`/upload/sound-effects/${filename}`);
            showToast('Sound effect deleted successfully', 'success');

            // Reload list
            await loadSoundEffects();

            // Re-check button state (it will be hidden if selection clears to empty)
            updateDeleteButtonState(selectId, selectId === 'soundEffectSelect' ? 'deleteSoundEffectBtn' : 'deleteEditSoundEffectBtn');

        } catch (error) {
            console.error('Delete error:', error);
            showToast(error.response?.data?.detail || 'Failed to delete sound effect', 'danger');
        }
    }

    function updateDeleteButtonState(selectId, btnId) {
        const select = document.getElementById(selectId);
        const btn = document.getElementById(btnId);
        if (select && btn) {
            // Enable button only if a value is selected
            btn.disabled = !select.value;
        }
    }

    // Attach listeners for delete button visibility
    document.addEventListener('DOMContentLoaded', () => {
        const createSelect = document.getElementById('soundEffectSelect');
        const editSelect = document.getElementById('editSoundEffectSelect');

        if (createSelect) {
            createSelect.addEventListener('change', () => updateDeleteButtonState('soundEffectSelect', 'deleteSoundEffectBtn'));
            // Initial check
            updateDeleteButtonState('soundEffectSelect', 'deleteSoundEffectBtn');
        }
        if (editSelect) {
            editSelect.addEventListener('change', () => updateDeleteButtonState('editSoundEffectSelect', 'deleteEditSoundEffectBtn'));
            // Initial check
            updateDeleteButtonState('editSoundEffectSelect', 'deleteEditSoundEffectBtn');
        }

        // Also hook into loadSoundEffects to update state after list reload? 
        // We can just rely on the user selecting something.
    });
</script>
{% endblock %}